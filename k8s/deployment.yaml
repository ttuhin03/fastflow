# Deployment für Fast-Flow auf Kubernetes
# Pipeline-Runs laufen als K8s-Jobs (kein Docker auf den Nodes nötig).
# Für Docker-basierte Runs: Docker Compose / Dockerfile nutzen.
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastflow-orchestrator
  labels:
    app: fastflow-orchestrator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fastflow-orchestrator
  template:
    metadata:
      labels:
        app: fastflow-orchestrator
    spec:
      serviceAccountName: fastflow-executor
      initContainers:
        - name: wait-for-postgres
          image: postgres:16-alpine
          command:
            - sh
            - -c
            - |
              if [ -n "$${DATABASE_URL}" ] && echo "$${DATABASE_URL}" | grep -q postgresql; then
                echo "Waiting for PostgreSQL..."
                until pg_isready -h postgres -p 5432 -U fastflow; do sleep 2; done
                echo "PostgreSQL ready"
              else
                echo "Using SQLite, skipping postgres wait"
              fi
          envFrom:
            - secretRef:
                name: postgres-secret
                optional: true
      containers:
        - name: orchestrator
          # bei echtem Deployment "ghcr.io/ttuhin03/fastflow-orchestrator:v0.7.1",
          image: fastflow-orchestrator:latest
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          ports:
            - containerPort: 8000
              name: http
          envFrom:
            - configMapRef:
                name: fastflow-config
            - secretRef:
                name: fastflow-secrets
                optional: true
            - secretRef:
                name: postgres-secret
                optional: true
          env:
            - name: PIPELINE_EXECUTOR
              value: "kubernetes"
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: KUBERNETES_CACHE_PVC_NAME
              value: "fastflow-cache-pvc"
            - name: KUBERNETES_SHARED_CACHE_MOUNT_PATH
              value: "/shared"
            - name: PIPELINES_DIR
              value: /app/pipelines
            - name: LOGS_DIR
              value: /app/logs
            - name: DATA_DIR
              value: /app/data
            - name: UV_CACHE_DIR
              value: /app/data/uv_cache
            - name: UV_PYTHON_INSTALL_DIR
              value: /app/data/uv_python
          volumeMounts:
            - name: fastflow-storage
              mountPath: /app/data
              subPath: data
            - name: fastflow-storage
              mountPath: /app/logs
              subPath: logs
            - name: fastflow-storage
              mountPath: /app/pipelines
              subPath: pipelines
            - name: cache-pvc
              mountPath: /shared
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: 8000
            initialDelaySeconds: 40
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: fastflow-storage
          persistentVolumeClaim:
            claimName: fastflow-pvc
        - name: cache-pvc
          persistentVolumeClaim:
            claimName: fastflow-cache-pvc
