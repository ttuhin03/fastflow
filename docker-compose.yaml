services:
  # Docker Socket Proxy (Security Layer)
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: fastflow-docker-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Allow container operations (create, start, stop, remove, logs, stats)
      - CONTAINERS=1
      # Allow image pulling and inspection
      - IMAGES=1
      # Allow build operations (might be needed for some operations)
      - BUILD=1
      # Disable network management (not needed)
      - NETWORKS=0
      # Allow volume operations (needed for volume mounts in containers)
      - VOLUMES=1
      # Disable system operations (not needed)
      - SYSTEM=0
      # Allow exec operations (for container inspection)
      - EXEC=1
      # HTTP Verb permissions (CRITICAL for container creation)
      - POST=1        # Allows /create, /start, /stop, /pull etc.
      - DELETE=1      # Allows container removal after run
      - STATS=1       # Explicitly needed for resource monitoring
    networks:
      - fastflow-network
    restart: unless-stopped
    # Port 2375 nicht auf Host exponieren; Orchestrator erreicht Proxy nur im internen Netz (Sicherheit)
    ports: []

  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fastflow-orchestrator
    image: fastflow-orchestrator:latest
    
    # Docker-Socket-Mount entfernt - Kommunikation erfolgt über docker-proxy
    # ⚠️ SECURITY: Docker-Socket wird nur noch vom docker-proxy-Service gemountet
    # Der Orchestrator kommuniziert über HTTP mit dem Proxy (http://docker-proxy:2375)
    volumes:
      # Pipeline-Repository (wird als Volume gemountet, konfigurierbar)
      - ${PIPELINES_DIR:-./pipelines}:/app/pipelines:rw
      # Runner-Skripte (Notebook-Runner etc.) – Host-Pfad wird für Worker-Volume benötigt
      - ./app/runners:/app/app/runners:ro
      # Log-Verzeichnis (persistente Logs)
      - ${LOGS_DIR:-./logs}:/app/logs:rw
      # Daten-Verzeichnis (Datenbank, persistente Daten)
      - ${DATA_DIR:-./data}:/app/data:rw
      # UV-Cache-Verzeichnis (shared zwischen allen Container-Runs)
      - ${UV_CACHE_DIR:-./data/uv_cache}:/app/data/uv_cache:rw
      # UV-Python-Installationen (uv python install; für Preheating und Worker)
      - ${DATA_DIR:-./data}/uv_python:/app/data/uv_python:rw
    
    # Environment-Variablen (aus .env oder direkt)
    env_file:
      - .env
    environment:
      # Verzeichnis-Pfade (innerhalb Container)
      - PIPELINES_DIR=/app/pipelines
      - LOGS_DIR=/app/logs
      - DATA_DIR=/app/data
      - UV_CACHE_DIR=/app/data/uv_cache
      - UV_PYTHON_INSTALL_DIR=/app/data/uv_python
      # OAuth-Redirect: Frontend wird vom gleichen Server (Orchestrator) auf :8000 ausgeliefert
      - FRONTEND_URL=http://localhost:${PORT:-8000}
      - BASE_URL=http://localhost:${PORT:-8000}
      # Host-Pfade für Docker Volume-Mounts (wichtig für Worker-Container)
      # Diese werden automatisch aus den Container-Volumes extrahiert
      # Falls manuell gesetzt werden soll, verwende absolute Pfade
      # - PIPELINES_HOST_DIR=/absoluter/host/pfad/pipelines
      # - UV_CACHE_HOST_DIR=/absoluter/host/pfad/data/uv_cache
    
    # Port-Mapping (FastAPI + React Frontend)
    ports:
      - "${PORT:-8000}:8000"
    
    # Restart-Policy
    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health-Check (optional)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Netzwerk (optional, für Multi-Container-Setups)
    networks:
      - fastflow-network

  # Docusaurus-Doku (statisch, Port 3001)
  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    container_name: fastflow-docs
    image: fastflow-docs:latest
    ports:
      - "3001:3001"
    restart: unless-stopped
    networks:
      - fastflow-network

# Netzwerk-Definition
networks:
  fastflow-network:
    driver: bridge

# Hinweise:
# - Worker-Image (WORKER_BASE_IMAGE) muss nicht gebaut werden, wird von Registry gepullt
# - Standard: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
# - Docker-Socket-Mount ist erforderlich für Container-Management
# - Alle Volumes sind konfigurierbar über Environment-Variablen
# - .env-Datei sollte im Projekt-Root erstellt werden (siehe .env.example)
