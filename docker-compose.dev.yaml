services:
  # Backend (FastAPI)
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fastflow-orchestrator
    image: fastflow-orchestrator:latest
    
    # Docker-Socket-Mount (KRITISCH für Container-Management)
    # ⚠️ SECURITY-WARNUNG: Docker-Socket gibt Root-Zugriff auf Host-System!
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${PIPELINES_DIR:-./pipelines}:/app/pipelines:rw
      - ${LOGS_DIR:-./logs}:/app/logs:rw
      - ${DATA_DIR:-./data}:/app/data:rw
      - ${UV_CACHE_DIR:-./data/uv_cache}:/app/data/uv_cache:rw
      # Development: Mount App-Code für Hot-Reload
      - ./app:/app/app:ro
      - ./alembic:/app/alembic:ro
      - ./alembic.ini:/app/alembic.ini:ro
    
    env_file:
      - .env
    environment:
      - PIPELINES_DIR=/app/pipelines
      - LOGS_DIR=/app/logs
      - DATA_DIR=/app/data
      - UV_CACHE_DIR=/app/data/uv_cache
      # Host-Pfade für Docker Volume-Mounts (wichtig für Worker-Container)
      # Diese werden automatisch aus den Container-Volumes extrahiert
      # Falls manuell gesetzt werden soll, verwende absolute Pfade
      # - PIPELINES_HOST_DIR=/absoluter/host/pfad/pipelines
      # - UV_CACHE_HOST_DIR=/absoluter/host/pfad/data/uv_cache
    
    ports:
      - "${PORT:-8000}:8000"
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - fastflow-network

  # Frontend (React Development Server)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: fastflow-frontend
    image: fastflow-frontend:dev
    
    volumes:
      # Mount Source-Code für Hot-Reload
      - ./frontend:/app:rw
      - /app/node_modules
    
    ports:
      - "3000:3000"
    
    environment:
      - VITE_API_URL=http://localhost:8000/api
      - CHOKIDAR_USEPOLLING=true  # Für Hot-Reload in Docker
    
    depends_on:
      - orchestrator
    
    networks:
      - fastflow-network

networks:
  fastflow-network:
    driver: bridge
