services:
  # Docker Socket Proxy (Security Layer)
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: fastflow-docker-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Allow container operations (create, start, stop, remove, logs, stats)
      - CONTAINERS=1
      # Allow image pulling and inspection
      - IMAGES=1
      # Allow build operations (might be needed for some operations)
      - BUILD=1
      # Disable network management (not needed)
      - NETWORKS=0
      # Allow volume operations (needed for volume mounts in containers)
      - VOLUMES=1
      # Disable system operations (not needed)
      - SYSTEM=0
      # Allow exec operations (for container inspection)
      - EXEC=1
      # HTTP Verb permissions (CRITICAL for container creation)
      - POST=1        # Allows /create, /start, /stop, /pull etc.
      - DELETE=1      # Allows container removal after run
      - STATS=1       # Explicitly needed for resource monitoring
    networks:
      - fastflow-network
    restart: unless-stopped
    # Expose proxy on port 2375 (Docker API port)
    ports:
      - "2375:2375"

  # Backend (FastAPI)
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fastflow-orchestrator
    image: fastflow-orchestrator:latest
    
    # Docker-Socket-Mount entfernt - Kommunikation erfolgt über docker-proxy
    # ⚠️ SECURITY: Docker-Socket wird nur noch vom docker-proxy-Service gemountet
    # Der Orchestrator kommuniziert über HTTP mit dem Proxy (http://docker-proxy:2375)
    volumes:
      - ${PIPELINES_DIR:-./pipelines}:/app/pipelines:rw
      - ${LOGS_DIR:-./logs}:/app/logs:rw
      - ${DATA_DIR:-./data}:/app/data:rw
      - ${UV_CACHE_DIR:-./data/uv_cache}:/app/data/uv_cache:rw
      # Development: Mount App-Code für Hot-Reload
      - ./app:/app/app:ro
      - ./alembic:/app/alembic:ro
      - ./alembic.ini:/app/alembic.ini:ro
    
    env_file:
      - .env
    environment:
      - PIPELINES_DIR=/app/pipelines
      - LOGS_DIR=/app/logs
      - DATA_DIR=/app/data
      - UV_CACHE_DIR=/app/data/uv_cache
      # Host-Pfade für Docker Volume-Mounts (wichtig für Worker-Container)
      # Diese werden automatisch aus den Container-Volumes extrahiert
      # Falls manuell gesetzt werden soll, verwende absolute Pfade
      # - PIPELINES_HOST_DIR=/absoluter/host/pfad/pipelines
      # - UV_CACHE_HOST_DIR=/absoluter/host/pfad/data/uv_cache
    
    ports:
      - "${PORT:-8000}:8000"
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - fastflow-network

  # Frontend (React Development Server)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: fastflow-frontend
    image: fastflow-frontend:dev
    
    volumes:
      # Mount Source-Code für Hot-Reload
      - ./frontend:/app:rw
      - /app/node_modules
    
    ports:
      - "3000:3000"
    
    environment:
      - VITE_API_URL=http://localhost:8000/api
      - VITE_DOCS_URL=http://localhost:3001
      - CHOKIDAR_USEPOLLING=true  # Für Hot-Reload in Docker
    
    depends_on:
      - orchestrator
      - docker-proxy
    
    networks:
      - fastflow-network

  # Docusaurus-Doku (statisch, Port 3001)
  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    container_name: fastflow-docs
    image: fastflow-docs:latest
    ports:
      - "3001:3001"
    restart: unless-stopped
    networks:
      - fastflow-network

networks:
  fastflow-network:
    driver: bridge
